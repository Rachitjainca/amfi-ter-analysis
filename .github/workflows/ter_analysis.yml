name: AMFI TER Daily Analysis

on:
  schedule:
    # Run daily at 7:35 AM IST (02:05 UTC)  
    - cron: '5 2 * * *'
  workflow_dispatch:
    branches:
      - main

jobs:
  ter-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas openpyxl requests
      
      - name: Create directories
        run: mkdir -p downloads output history logs
      
      - name: Download and analyze TER files
        id: analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python ter_github_actions.py
      
      - name: List generated files
        run: |
          echo "=== Downloads ==="
          ls -lh downloads/ 2>/dev/null || echo "No downloads yet"
          echo ""
          echo "=== Output Files ==="
          ls -lh output/ 2>/dev/null || echo "No output files"
      
      - name: Read analysis summary
        id: summary
        run: |
          if [ -f analysis_summary.json ]; then
            cat analysis_summary.json
            echo "SUMMARY=$(cat analysis_summary.json | tr '\n' ' ')" >> $GITHUB_ENV
          else
            echo "SUMMARY=No summary available" >> $GITHUB_ENV
          fi
      
      - name: Commit and push results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Auto: AMFI TER Analysis - $(date +'%Y-%m-%d %H:%M:%S')" || exit 0
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          for attempt in 1 2 3; do
            if git push origin main; then
              echo "Push successful on attempt $attempt"
              exit 0
            fi
            echo "Push failed on attempt $attempt, retrying..."
            sleep 5
          done
          echo "Warning: Could not push results after 3 attempts"
          exit 0
        continue-on-error: true
      
      - name: Send Google Chat Notification
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "Webhook URL not configured"
            exit 0
          fi
          
          STATUS="${{ job.status }}"
          DATE=$(date '+%Y-%m-%d')
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          python3 << PYTHON_SCRIPT
import json
import urllib.request
import os

try:
    status = os.environ.get('STATUS', 'unknown')
    date = os.environ.get('DATE', 'unknown')
    run_url = os.environ.get('RUN_URL', '')
    webhook_url = os.environ.get('WEBHOOK_URL', '')
    
    message = ""
    if os.path.exists("notification_message.txt"):
        with open("notification_message.txt", "r") as f:
            message = f.read()
    
    final_message = f"AMFI TER Daily Analysis - {date}\n\n{message}\n\nStatus: {status}\nView: {run_url}"
    
    if webhook_url:
        payload = {"text": final_message}
        req = urllib.request.Request(
            webhook_url,
            data=json.dumps(payload).encode('utf-8'),
            headers={'Content-Type': 'application/json'}
        )
        try:
            with urllib.request.urlopen(req) as response:
                print(f"Notification sent. Status: {response.status}")
        except Exception as e:
            print(f"Error sending notification: {e}")
    else:
        print("Webhook URL not configured")
except Exception as e:
    print(f"Error: {e}")
PYTHON_SCRIPT
        continue-on-error: true
