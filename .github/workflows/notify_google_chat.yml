name: Google Chat Notifications

on:
  workflow_run:
    workflows: ["AMFI TER Daily Analysis"]
    types: [completed]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Download artifacts
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: ter_analysis.yml
          name: ter-analysis-results
          path: ./artifacts
        continue-on-error: true

      - name: Read analysis results
        id: read_results
        run: |
          # Try to read summary from artifacts first, then from main branch
          SUMMARY_FILE="./artifacts/analysis_summary.json"
          if [ ! -f "$SUMMARY_FILE" ]; then
            SUMMARY_FILE="./analysis_summary.json"
          fi
          
          MESSAGE_FILE="./artifacts/notification_message.txt"
          if [ ! -f "$MESSAGE_FILE" ]; then
            MESSAGE_FILE="./notification_message.txt"
          fi
          
          # Set simple flags if files exist
          if [ -f "$SUMMARY_FILE" ]; then
            echo "SUMMARY_EXISTS=true" >> $GITHUB_ENV
          else
            echo "SUMMARY_EXISTS=false" >> $GITHUB_ENV
          fi
          
          if [ -f "$MESSAGE_FILE" ]; then
            echo "MESSAGE_EXISTS=true" >> $GITHUB_ENV
          else
            echo "MESSAGE_EXISTS=false" >> $GITHUB_ENV
          fi
        continue-on-error: true

      - name: Install dependencies
        run: |
          pip install requests

      - name: Send Google Chat notification
        env:
          WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}
          WORKFLOW_CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.event.workflow_run.id }}
        run: python3 << 'EOF'
import json
import requests
import os
from datetime import datetime

webhook_url = os.getenv('WEBHOOK_URL')
if not webhook_url:
    print("âŒ GOOGLE_CHAT_WEBHOOK_URL not configured")
    exit(1)

conclusion = os.getenv('WORKFLOW_CONCLUSION', 'unknown')
repo = os.getenv('REPO', '')
run_id = os.getenv('RUN_ID', '')

# Determine status emoji and text
if conclusion == 'success':
    status_emoji = 'âœ…'
    status_text = 'Success'
elif conclusion == 'failure':
    status_emoji = 'âŒ'
    status_text = 'Failed'
else:
    status_emoji = 'âš ï¸'
    status_text = conclusion.capitalize()

# Build the message
message = {
    "cards": [{
        "header": {
            "title": "AMFI TER Daily Analysis",
            "subtitle": f"Analysis Report - {datetime.now().strftime('%Y-%m-%d %H:%M:%S IST')}"
        },
        "sections": [
            {
                "widgets": [
                    {
                        "keyValue": {
                            "topLabel": "Status",
                            "content": f"{status_emoji} {status_text}",
                            "contentMultiline": False
                        }
                    }
                ]
            },
            {
                "widgets": [
                    {
                        "keyValue": {
                            "topLabel": "Repository",
                            "content": repo,
                            "contentMultiline": False
                        }
                    },
                    {
                        "keyValue": {
                            "topLabel": "Workflow Run",
                            "content": f"View: https://github.com/{repo}/actions/runs/{run_id}",
                            "contentMultiline": False
                        }
                    }
                ]
            },
            {
                "widgets": [
                    {
                        "textParagraph": {
                            "text": "ðŸ“Š TER Analysis Complete"
                        }
                    }
                ]
            }
        ]
    }]
}

try:
    response = requests.post(webhook_url, json=message, timeout=10)
    if response.status_code == 200:
        print(f"âœ… Notification sent successfully to Google Chat")
    else:
        print(f"âŒ Failed to send notification: {response.status_code}")
        print(response.text)
except Exception as e:
    print(f"âŒ Error sending notification: {e}")
EOF

      - name: Handle missing webhook
        if: failure()
        run: |
          echo "âš ï¸  Cannot send Google Chat notification"
          echo "To enable notifications:"
          echo "1. Create a Google Chat webhook: https://support.google.com/chat/answer/7655820"
          echo "2. Add secret GOOGLE_CHAT_WEBHOOK_URL to GitHub repository"
          echo "3. See GOOGLE_CHAT_SETUP.md for detailed instructions"
