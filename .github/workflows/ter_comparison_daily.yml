name: Daily TER Comparison Report

on:
  workflow_run:
    workflows: ["AMFI TER Daily Analysis"]
    types: [completed]
  workflow_dispatch:

jobs:
  compare_ter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Pull latest changes
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git pull origin main || true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pandas requests

      - name: Generate TER Comparison Report
        run: |
          python generate_ter_comparison.py

      - name: Send to Google Chat Webhook
        env:
          WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}
        run: python3 << 'SEND_WEBHOOK'
import json
import requests
import os
import pandas as pd
from datetime import datetime

webhook_url = os.getenv('WEBHOOK_URL')
if not webhook_url:
    print("‚ùå GOOGLE_CHAT_WEBHOOK_URL not configured")
    exit(1)

# Read the significant changes file
try:
    df = pd.read_csv('./output/TER_Comparison_Significant.csv')
    if len(df) == 0:
        print("‚ö†Ô∏è  No significant changes found (threshold > 0.02)")
        exit(0)
except:
    print("‚ùå Could not read TER_Comparison_Significant.csv")
    exit(1)

# Categorize data
def categorize_fund(scheme_name):
    scheme_lower = scheme_name.lower()
    if any(x in scheme_lower for x in ['equity', 'growth', 'largecap', 'midcap', 'smallcap']):
        return 'Equity'
    elif any(x in scheme_lower for x in ['debt', 'bond', 'duration', 'liquid', 'gilt']):
        return 'Debt'
    elif any(x in scheme_lower for x in ['hybrid', 'balanced', 'arbitrage', 'savings']):
        return 'Hybrid/Mixed'
    elif any(x in scheme_lower for x in ['index', 'nifty', 'sensex', 'etf']):
        return 'Index/ETF'
    elif 'fof' in scheme_lower or 'fund of funds' in scheme_lower:
        return 'Fund of Funds'
    else:
        return 'Other'

df['Category'] = df['Scheme Name'].apply(categorize_fund)

# Get top 15 schemes overall
top_15 = df.nlargest(15, 'Difference (Reg Change - Dir Change)')

# Build sections for each category
sections = []

# Summary section
summary_text = f"<b>üìä Daily TER Comparison Report</b><br>"
summary_text += f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S IST')}<br><br>"
summary_text += f"Total Schemes with Changes: {len(df)}<br>"
summary_text += f"Filter Applied: Difference > 0.02 | Threshold: 0.02<br><br>"

sections.append({
    "widgets": [{
        "textParagraph": {"text": summary_text}
    }]
})

# Category breakdown
cat_text = "<b>üìÇ By Fund Category:</b><br>"
for cat in sorted(df['Category'].unique()):
    count = len(df[df['Category'] == cat])
    cat_text += f"‚Ä¢ {cat}: {count} schemes<br>"

sections.append({
    "widgets": [{
        "textParagraph": {"text": cat_text}
    }]
})

# Top 15 schemes
top_text = "<b>üîù Top 15 Schemes (Highest Difference):</b><br><br>"
for idx, (_, row) in enumerate(top_15.iterrows(), 1):
    scheme = row['Scheme Name'][:40]
    reg_change = f"{row['Regular Base TER New'] - row['Regular Base TER Old']:+.2f}"
    dir_change = f"{row['Direct Base TER New'] - row['Direct Base TER Old']:+.2f}"
    diff = row['Difference (Reg Change - Dir Change)']
    
    top_text += f"{idx:2d}. <b>{scheme}</b><br>"
    top_text += f"    Reg: {reg_change} | Dir: {dir_change} | Diff: <b>{diff:+.4f}</b><br><br>"

sections.append({
    "widgets": [{
        "textParagraph": {"text": top_text}
    }]
})

# Build the message
message = {
    "cards": [{
        "header": {
            "title": "üìä Daily TER Comparison Report",
            "subtitle": f"Filtered Changes (Threshold > 0.02)"
        },
        "sections": sections
    }]
}

try:
    response = requests.post(webhook_url, json=message, timeout=10)
    if response.status_code == 200:
        print(f"‚úÖ Report sent to Google Chat - {len(df)} schemes with significant changes")
    else:
        print(f"‚ùå Failed: {response.status_code}")
        print(response.text)
except Exception as e:
    print(f"‚ùå Error: {e}")
    exit(1)

SEND_WEBHOOK

      - name: Commit and Push Results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add output/TER_Comparison_*.csv
          git commit -m "Daily TER Comparison Report - $(date -u +'%Y-%m-%d')" || echo "No changes to commit"
          git push || echo "Nothing to push"
        continue-on-error: true
